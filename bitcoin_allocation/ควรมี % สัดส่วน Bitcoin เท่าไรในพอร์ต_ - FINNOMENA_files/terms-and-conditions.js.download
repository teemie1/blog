jQuery(document).ready(function ($) {	
    const user_id = $('#terms_cond_user_id').val()
    $('#consent-banner').hide()
    $('#consent-banner_container').removeClass('d-none')

	$(document).on('click', '#banner-button', function (e) {
        let elementSticky = document.getElementById("sticky__ads__section");
        function handleEleSticky() {
            let width = window.screen.width
            if(width >= 1024){ elementSticky.style.bottom = "16px";}
            else elementSticky.style.bottom = "8px";
        }
        if(elementSticky) {
            handleEleSticky()
            window.addEventListener('resize', handleEleSticky);
        }
		e.preventDefault()
    })

    async function getTermsCondCookie(user_id) {
        const policyAccepted = getCookie("terms_cond_accepted")
        const isTrue = data => data == "true"

        if (+user_id) {
            try {
                await _ajaxApi("GET", null , isTrue(policyAccepted));
            } catch (error) {
                console.error('getTermsCondCookie user info error: ', error)
            }
            $('#consent-banner').show()
            $('#open-in-app').hide()
        } else if (policyAccepted == '') {
            setCookie('terms_cond_accepted', false)
            $('#consent-banner').show()
            $('#open-in-app').hide()
        } else if (isTrue(policyAccepted)) {
            $('#consent-banner').hide()
        } else {
            $('#consent-banner').show()
            $('#open-in-app').hide()
        }
    }

    async function updateTermsCondCookie(user_id, status) {
        if (+user_id) {
            try {
                setCookie('terms_cond_accepted', status)
                await _ajaxApi("POST", { status }, status)
            } catch (error) {
                console.error('updateTermsCondCookie error: ', error)
            }
            
        } else {
            $('#consent-banner').hide()
            setCookie('terms_cond_accepted', status)
        }
    }

    function _ajaxApi(method, payload = null, policyAccepted) {
        const endpoint = '/wp-content/themes/finno_v2/services/nds/terms_and_cond.php'

        $.ajax({
            method: method,
            url: endpoint,
            async: true,
            data: JSON.stringify(payload),
            dataType : "json",
            contentType: "application/json; charset=utf-8",
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", "Bearer " + user_id)
            },
            success: function (result) {
                const userAccept = result.data.status || policyAccepted

                if (userAccept) $('#consent-banner').hide()
                if (!result.data.status && policyAccepted) {
                    updateTermsCondCookie(user_id, true)
                }
            },
            error: function (error) {
                console.error('Call service error: ', error)
            }
        })
    }

    function getCookie(cname) {
        var name = cname + '='
        var decodedCookie = decodeURIComponent(document.cookie)
        var ca = decodedCookie.split(';')
        for ( var i = 0; i < ca.length; i++ ) {
          var c = ca[i]
          while (c.charAt(0) == ' ') {
            c = c.substring(1)
          }
          if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length)
          }
        }
        
        return ''
    }

    function setCookie(cname, cvalue) {
        let now = new Date();
        let time = now.getTime();
        let expireTime = time + 1000*60*60*24*365; //ms*sec*min*hr*days
        now.setTime(expireTime);
        document.cookie = cname + '=' + cvalue + '; expires=' +now.toGMTString()+ '; path=/'
    }

})
